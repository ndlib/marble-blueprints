
Parameters:

  InfrastructureStackName:
    Type: String
    Default: marble-app-infrastructure
    Description: The name of the parent infrastructure/networking stack that you created. Necessary
                 to locate and reference resources created by that stack.

  EnvType:
    Type: String
    Description: The type of environment to create.
    Default: dev
    AllowedValues:
      - dev
      - prod
    ConstraintDescription: must specify prod or dev.

Mappings:
  # Settings to use for each environment.
  EnvTypeSettings:
    dev:
      CorsOrigins:
        - "*.library.nd.edu"
        - "*.libraries.nd.edu"
        - "*.cloudfront.net"
        - "http://universalviewer.io"
    prod:
      CorsOrigins:
        # This will probably need to change to allow overrides via params somehow,
        # but not going to fight it now since this is a place holder for data-broker
        - "*.library.nd.edu"

Outputs:

  PublicBucket:
    Description: A temporary bucket to share assets publicly for Marble project
    Value: !Ref PublicBucket

Resources:

  PublicBucketParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub '/all/stacks/${AWS::StackName}/publicbucket'
      Value: !Ref PublicBucket
      Description: The name of the public bucket for IIIF Services

  PublicBucket:
    Type: AWS::S3::Bucket
    Properties:
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedOrigins: !FindInMap [EnvTypeSettings, !Ref EnvType, "CorsOrigins"]
            AllowedMethods: [GET]
            MaxAge: 3600
      LoggingConfiguration:
        DestinationBucketName:
          Fn::ImportValue: !Join [':', [!Ref InfrastructureStackName, 'LogBucket']]
        LogFilePrefix: s3/data-broker/
      WebsiteConfiguration:
        IndexDocument: index.html

  PublicBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: F16
            reason: "This is currently designed as a public bucket, so it's acceptable to have * principal"
    Properties:
      Bucket: !Ref PublicBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
            Resource: !Sub ${PublicBucket.Arn}/*
            Principal: '*'

  DebugPermissions:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - !ImportValue
            Fn::Sub: ${InfrastructureStackName}:DebugRoleName
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowReadBuckets
            Effect: Allow
            Action:
              - 's3:GetObject'
              - 's3:ListBucket'
            Resource:
              - !GetAtt PublicBucket.Arn
              - !Sub ${PublicBucket.Arn}/*

  DataAdminPermissions:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - !ImportValue
            Fn::Sub: ${InfrastructureStackName}:DataAdminRoleName
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowReadBuckets
            Effect: Allow
            Action:
              - 's3:GetObject'
              - 's3:ListBucket'
            Resource:
              - !GetAtt PublicBucket.Arn
              - !Sub ${PublicBucket.Arn}/*
